<%= form_for(repair_order, url: repair_order_path(repair_order), html: { class: "form-horizontal", role: "form" }) do |f| %>
  <% if repair_order.errors.any? %>
    <div class="alert alert-dismissable alert-danger">
      <button type="button" class="close" data-dismiss="alert">Ã—</button>
      <h2><%= pluralize(repair_order.errors.count, "error") %> prohibited this debt from being saved:</h2>
        <ul>
        <% repair_order.errors.full_messages.each do |message| %>
        <li><%= message %></li>
        <% end %>
      </ul>
      <%= notice %>
    </div>
  <% end %>

<div class="col-lg-6">
  <div class="well bs-component">
    <form class="form-horizontal">

      <div class="form-group">
        <%= f.label :order_number, class:'col-lg-2 control-label' %>
        <div class="col-lg-10">
          <%= f.number_field :order_number, class:'form-control', required:true, value: (repair_order.order_number.nil? ? @last_repair_order_id + 1 : repair_order.order_number) %>
        </div>
      </div>

      <div class="form-group">
        <%= f.label t(:type), class: "col-sm-2 control-label" %>
        <div class="col-sm-10">
          <select id="type_select" name="repair_order[type]" class="form-control" required="true">
            <option value="Campaign"><%= t('campaign') %></option>
            <option value="Warranty"><%= t('warranty') %></option>
            <option value="Maintenance"><%= t('maintenance') %></option>
            <option value="Repair"><%= t('repair') %></option>
            <option value="Service"><%= t('service') %></option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <%= f.label t(:search_car), class:'col-lg-2 control-label'  %>
        <div class="col-lg-4 search-car-toggle">
          <div class="togglebutton">
            <label>
              <%= t('by_ci') %> &nbsp; &nbsp;<input id="toggle_button" onClick="changeSearchType(this);" type="checkbox" checked> <%= t('by_chassis_number') %>
            </label>
          </div>
        </div>
        <div class="col-lg-6">
          <%= f.text_field :car_chassis_number, class:'form-control', data: { autocomplete_source: '/chassis_numbers'} %>
          <%= f.text_field :ci_number, class:'form-control hidden', data: { autocomplete_source: '/cis'} %>
        </div>
      </div>

      <div id="car_info_group" class="form-group">
        <%= f.label t(:car), class:'col-lg-2 control-label' %>
        <div class="col-lg-10">
          <div id="car_info"></div>
        </div>
      </div>

      <%= f.hidden_field :car_id %>

      <div id="car_select" class="form-group hidden">
        <%= f.label :car_id, class:'col-lg-2 control-label'  %>
        <div class="col-lg-10">
          <%= f.collection_select(:car_select, [], :id, :name,{},{ class: "form-control" }) %>
        </div>
      </div>

      <div class="form-group">
        <%= f.label :description, class:'col-lg-2 control-label' %>
        <div class="col-lg-10">
          <%= f.text_area :description, class:'form-control', required:true, rows: 4 %>
        </div>
      </div>

      <div class="form-group">
        <%= f.label :ajax, class:'col-lg-2 control-label' %>
        <div class="checkbox">
          <label>
           <%= f.check_box :ajax %><span class="checkbox-material"></span>
          </label>
<!--           <div class="row-content">
            <div class="action-secondary">
              <i class="material-icons">info</i>
            </div>
            <h4 class="list-group-item-heading">Tile with an icon</h4>

            <p class="list-group-item-text">Maecenas sed diam eget risus varius blandit.</p>
          </div> -->
        </div>
      </div>

      <div id="claim_number" class="form-group">
        <%= f.label :claim_number, class:'col-lg-2 control-label' %>
        <div class="col-lg-10">
          <%= f.number_field :claim_number, class:'form-control' %>
        </div>
      </div>

      <div id="operation_number" class="form-group">
        <%= f.label :operation_number, class:'col-lg-2 control-label' %>
        <div class="col-lg-10">
          <%= f.text_field :operation_number, class:'form-control' %>
        </div>
      </div>

      <div class="form-group">
        <div class="col-lg-10 col-lg-offset-2">
          <%= f.submit class:"btn btn-primary" %>
        </div>
      </div>
    </form>
  </div>
</div>
<script type="text/javascript">
  $('#repair_order_car_chassis_number').autocomplete({ source: $('#repair_order_car_chassis_number').data('autocomplete-source')});
  //$("#repair_order_car_chassis_number").data("ui-autocomplete")._trigger("change")
  $('#repair_order_ci_number').autocomplete({source: $('#repair_order_ci_number').data('autocomplete-source')});

  $('#repair_order_car_chassis_number').on('change input autocompleteselect',function(event, ui){
    // console.log($(this).val().length);
    // console.log(ui);
    if ($(this).val().length == 17)
      selectCar('/get_car_by_chassis_number/'+$(this).val());
    else if (ui)
      selectCar('/get_car_by_chassis_number/'+ui.item.value);

  })
  $('#repair_order_ci_number').on('change input autocompleteselect',function(event, ui){
    console.log($(this).val().length);
    console.log(ui);
    if (ui)
      selectCar('/get_car_by_client_identification/'+ui.item.value);
    else if ($(this).val().length > 0)
      selectCar('/get_car_by_client_identification/'+$(this).val());
  })
  $('#type_select').change(function(){
    toggleSelect(this);
  });
  $('#repair_order_car_select').change(function(){
    console.log($(this).val());
    $('#repair_order_car_id').val($(this).val());
  });

  function selectCar(url) {
    $.get(url,function(data){
        console.log(data.length)
        if (data.length > 1)
        {
          $('#car_select').removeClass('hidden');
          $('#car_info_group').addClass('hidden');
          $('#repair_order_car_select').html("");

          $.each(data, function (i, car) {
            $('#repair_order_car_select').append($('<option>', {
                value: car.id,
                html : car.brand + ' ' + car.model + ' (Matr&iacute;cula: '+ car.plate +')'
            }));
          });
          $('#repair_order_car_select').change();
        }
        else
        {
          $('#car_select').addClass('hidden');
          $('#car_info_group').removeClass('hidden');
          var car = data[0];
          if (car)
          {
            $('#car_info').html(car.brand + ' ' + car.model + ' (Matr&iacute;cula: '+ car.plate +')');
            $('#repair_order_car_id').val(car.id);
          }
        }
      });
  }
  function toggleSelect (selectEl) {
    if ($(selectEl).val() == "Campaign") {
      $('#claim_number').css('display', 'block');
      $('#operation_number').css('display', 'block');
    }
    else {
      $('#claim_number').css('display', 'none');
      $('#operation_number').css('display', 'none');
    }
  }
  function changeSearchType(elem) {

    if ($(elem).prop('checked'))
    {
      $('#repair_order_car_chassis_number').removeClass('hidden');
      $('#repair_order_ci_number').addClass('hidden');
    }
    else {
      $('#repair_order_car_chassis_number').addClass('hidden');
      $('#repair_order_ci_number').removeClass('hidden');
    }

  }
</script>
<% end %>
